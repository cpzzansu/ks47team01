<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/default_admin}">
<th:block layout:fragment="customContents">
    <h1 th:text="${contents}">[[${contents}]]</h1>
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <br>
                <div class="x_title">
                    <h2>상점상품관리<small>Shop</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                               aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Settings 1</a>
                                </li>
                                <li><a href="#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li><a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <table id="datatable-responsive" class="table table-striped table-bordered dt-responsive nowrap loading-hide"
                               cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th class="admin-check-box-td"><input type="checkbox" class="admin-check-box chb-up"></th>
                                <th>상품키트코드</th>
                                <th>관리자 직원 아이디</th>
                                <th>키트 번호</th>
                                <th>키트 이름</th>
                                <th>키트 제목</th>
                                <th>키트 내용</th>
                                <th>키트 가격</th>
                                <th>키트 배송가능일</th>
                                <th>등록 시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="l : ${goodsKitList}" th:id="${l.goodsKitCode}">
                                <td class="admin-check-box-td"><input type="checkbox" class="admin-check-box chb-down" th:value="${l.goodsKitCode}"></td>
                                <td>goodsKitCode</td>
                                <td>urbanfarmAdminId</td>
                                <td>urbanKitCode</td>
                                <td>urbanKitName</td>
                                <td>goodsKitTitle</td>
                                <td>goodsKitContents</td>
                                <td>goodsKitPrice</td>
                                <td>goodsKitDeliveryDate</td>
                                <td>goodsKitRegDate</td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn-outline loading-hide" id="shop-add">등록</button>
                    <button type="button" class="btn-outline loading-hide" id="shop-modify">수정</button>
                    <button type="button" class="btn-outline loading-hide" id="shop-remove">삭제</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="customJs">
    <script>
        // 오름차, 내림차순 정렬 숫자
        $(document).ready(function () {
            function naturalSort(a, b) {
                let re = /(\d+)/g;
                a = String(a).split(re);
                b = String(b).split(re);
                let anum, bnum;

                while (a.length && b.length) {
                    anum = a.shift();
                    bnum = b.shift();
                    if (isNaN(anum) || isNaN(bnum)) {
                        if (anum !== bnum) return anum > bnum ? 1 : -1;
                    } else {
                        anum = Number(anum);
                        bnum = Number(bnum);
                        if (anum !== bnum) return anum > bnum ? 1 : -1;
                    }
                }
                return a.length - b.length;
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "natural-asc": function (a, b) {
                    return naturalSort(a, b);
                },

                "natural-desc": function (a, b) {
                    return naturalSort(a, b) * -1;
                }
            });
            if ($.fn.dataTable.isDataTable('#datatable-responsive')) {
                $('#datatable-responsive').DataTable().destroy();
            }
                let table = $('#datatable-responsive').DataTable({
                    "columnDefs": [
                        {"type": "natural", "targets": [1, 3]}, // 정렬
                        {"orderable": false, "targets": 0} // 표시X
                    ],
                    "order": [
                        [1, "asc"]
                    ]
                });
            // 로딩중 테이블 표시 X
            $('#datatable-responsive').removeClass('loading-hide');
            $('button').removeClass('loading-hide');
        });

        // 체크박스 일괄체크
        $(".chb-up").click(function () {
            if ($(".chb-up").is(":checked")) $(".chb-down").prop("checked", true);
            else $(".chb-down").prop("checked", false);
        });

        jQuery(".chb-down").click(function () {
            let total = $(".chb-down").length;
            let checked = $(".chb-down:checked").length;

            if (total != checked) $(".chb-up").prop("checked", false);
            else $(".chb-up").prop("checked", true);
        });

        // 체크박스 데이터 가져오고 삭제하기
        let checkedData = [];
        let finalCheckedData = [...new Set(checkedData)]

        $('.chb-down').on('change', function (){
            let value = $(this).val();

            if($(this).is(':checked')) {
                checkedData.push(value);
            } else {
              let index = checkedData.indexOf(value);
              if(index > -1) {
                  checkedData.splice(index, 1);
              }
            }
            finalCheckedData = [...new Set(checkedData)];
            console.log('check된 요소 : ' + finalCheckedData);
        });

        // 전체선택, 해제시 데이터 가져오고 삭제하기
        $('.chb-up').on('change', function (){
            let checkedBoxes = $('.chb-down');

            if($('.chb-up').is(':checked')) {
                checkedBoxes.each(function (){
                    checkedData.push($(this).val());
                })
            } else {
                checkedData.length = 0;
            }
            finalCheckedData = [...new Set(checkedData)];
            console.log('check된 요소 : ' + finalCheckedData);
        });

        // 등록버튼 클릭시 팝업
        $('#shop-add').on('click', function(){

            let width = 1000;
            let height = 1000;

            let left = Math.ceil(( window.screen.width - width )/2);
            let top = Math.ceil(( window.screen.height - height )/2);

            let windowStatus = 'width='+width+', height='+height+', left='+left+', top='+top+', scrollbars=yes, status=no, resizable=no, titlebar=no, location=no, toolbar=no, menubar=no';

            const url = "adminShopAdd";

            window.open(url, "상점상품등록", windowStatus);
        });

        // 수정버튼 클릭시 팝업

        // 삭제하기 클릭시 팝업
        $('#shop-remove').on('click', function (){
            if(confirm('정말로 삭제하시겠습니까?')) {
                $.ajax({
                    url: "adminShopRemove",
                    data:JSON.stringify({ checkedData: finalCheckedData }),
                    type: "POST",
                    contentType: 'application/json',
                    success: function(response) {
                        console.log(finalCheckedData);
                        alert('삭제되었습니다.');
                                if ($.fn.dataTable.isDataTable('#datatable-responsive')) {
                                    $('#datatable-responsive').DataTable().destroy();
                                }
                                $('#datatable-responsive').dataTable({
                                    ajax:{
                                        url: 'adminShopReload',
                                        type: 'GET',
                                        data: 'data',
                                        dataSrc: 'data'
                                    },
                                    columns:[
                                        {data : 'goodsKitCode', name : 'goodsKitCode'},
                                        {data : 'urbanfarmAdminId', name : 'urbanfarmAdminId'},
                                        {data : 'urbanKitCode', name : 'urbanKitCode'},
                                        {data : 'urbanKitName', name : 'urbanKitName'},
                                        {data : 'goodsKitTitle', name : 'goodsKitTitle'},
                                        {data : 'goodsKitContents', name : 'goodsKitContents'},
                                        {data : 'goodsKitDeliveryDate', name : 'goodsKitDeliveryDate'},
                                        {data : 'goodsKitRegDate', name : 'goodsKitRegDate'},
                                    ],
                                    success : function(response) {
                                        console.log("성공");
                                    }
                                })
                    },
                    fail: function(jqXHR, textStatus, errorThrown) {
                        alert('오류가 발생했습니다. ' + textStatus + ': ' + errorThrown);
                    }
                })
            } else {
                return false;
            }
        });

        // 신청하기 버튼
        // ks47team01\src\main\resources\templates\user_order\order_processing.html
        if($('.orderProcessingSubmit').length > 0){
            function orderProcessingSubmit() {
                alert('신청이 완료되었습니다.');
                window.close();
            }

            $('.orderProcessingSubmit').on('click', orderProcessingSubmit);
        }
    </script>
</th:block>
</html>