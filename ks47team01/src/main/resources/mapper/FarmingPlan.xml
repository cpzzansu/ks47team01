<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ks47team01.user.mapper.FarmingPlanMapper">

	<resultMap type="FarmingPlan" id="farmingPlanResultMap">
		<id column="farmer_farming_plan_code" property="farmerFarmingPlanCode"/>
		<result column="urbanfarmer_id" property="urbanfarmerId"/>
		<result column="urbanfarm_hub_crew_id" property="urbanfarmHubCrewId"/>
		<result column="crops_name_code" property="cropsNameCode"/>
		<result column="crops_name" property="cropsName"/>
		<result column="crops_growing_info_code" property="cropsGrowingInfoCode"/>
		<result column="urban_kit_code" property="urbanKitCode"/>
		<result column="farmer_farming_plan_reg_date" property="farmerFarmingPlanRegDate"/>
		<result column="farmer_farming_plan_start_date" property="farmerFarmingPlanStartDate"/>
		<result column="farmer_farming_plan_end_date" property="farmerFarmingPlanEndDate"/>
		<result column="farmer_farming_plan_status" property="farmerFarmingPlanStatus"/>
	</resultMap>
	
	<select id="autoIncreaseCode" resultType="String" parameterType="String">
		SELECT
			CONCAT('${tableName}_',MAX(CAST(SUBSTRING_INDEX(${tableName}_code,'_',-1) AS UNSIGNED))+1)
		FROM
			${tableName}
	</select>
	
	<select id="getMinManagementUser" resultType="map">
		/* 담당자수가 가장 적은 crew 반환 */
		SELECT
			p.urbanfarm_hub_crew_id AS min_crew_id,
			COUNT(p.urbanfarm_hub_crew_id) AS user_count
		FROM
			farmer_farming_plan AS p
		GROUP BY
			p.urbanfarm_hub_crew_id
		ORDER BY user_count
		LIMIT 1
	</select>
	
	<select id="getIncreseFarmingPlanCode" resultType="string">
		/* code 자동증가된 결과 반환 */
		SELECT
			CONCAT('farmer_farming_plan_',MAX(CAST(SUBSTRING_INDEX(farmer_farming_plan_code,'_',-1) AS UNSIGNED))+1) AS auto_code
		FROM
			farmer_farming_plan
	</select>
	
	<select id="getFarmingPlanListById" resultMap="farmingPlanResultMap" parameterType="String">
		/* 사용자별 계획 리스트 */
		SELECT
			farmer_farming_plan_code,
			crops_name,
			farmer_farming_plan_status
		FROM
			farmer_farming_plan
		WHERE
			urbanfarmer_id=#{userId}
	</select>
	
	<insert id="addCrops" parameterType="FarmingPlan">
		/* 농사 예정 작물 등록 */
		
		INSERT INTO farmer_farming_plan
			(farmer_farming_plan_code,
			 urbanfarmer_id, 
			 urbanfarm_hub_crew_id, 
			 crops_name_code, 
			 crops_name, 
			 crops_growing_info_code,
			 <if test="urbanKitCode !=null and urbanKitCode != ''">
				 urban_kit_code, 			 
			 </if> 
			 farmer_farming_plan_reg_date,
			 farmer_farming_plan_status)
		VALUES 
			(#{farmerFarmingPlanCode},
			 #{urbanfarmerId}, 
			 #{urbanfarmHubCrewId}, 
			 #{cropsNameCode}, 
			 #{cropsName}, 
			 #{cropsGrowingInfoCode},
			 <if test="urbanKitCode !=null and urbanKitCode != ''">
				 #{urbanKitCode}, 			 
			 </if> 
			 NOW(), 
			 '시작전')
	</insert>
</mapper>