<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ks47team01.user.mapper.FarmingPlanMapper">

	<resultMap type="FarmingPlan" id="farmingPlanResultMap">
		<id column="farmer_farming_plan_code" property="farmerFarmingPlanCode"/>
		<result column="urbanfarmer_id" property="urbanfarmerId"/>
		<result column="urbanfarm_hub_crew_id" property="urbanfarmHubCrewId"/>
		<result column="crops_name_code" property="cropsNameCode"/>
		<result column="crops_name" property="cropsName"/>
		<result column="crops_growing_info_code" property="cropsGrowingInfoCode"/>
		<result column="urban_kit_code" property="urbanKitCode"/>
		<result column="farmer_farming_plan_reg_date" property="farmerFarmingPlanRegDate"/>
		<result column="farmer_farming_plan_start_date" property="farmerFarmingPlanStartDate"/>
		<result column="farmer_farming_plan_end_date" property="farmerFarmingPlanEndDate"/>
		<result column="farmer_farming_plan_status" property="farmerFarmingPlanStatus"/>
	</resultMap>
	
	<select id="autoIncreaseCode" resultType="String" parameterType="String">
		<![CDATA[
		SELECT
			CASE
				WHEN COUNT(1) < 1 
				THEN '${tableName}_1'
			ELSE	
				CONCAT('${tableName}_',MAX(CAST(SUBSTRING_INDEX(${tableName}_code,'_',-1) AS UNSIGNED))+1)
			END AS increase_code
		FROM
			${tableName}
		]]>
	</select>
	
	<select id="getMinManagementUser" resultType="map">
		/* 담당자수가 가장 적은 crew 반환 */
		SELECT
			c.urbanfarm_hub_crew_id AS min_crew_id,
			COUNT(f.urbanfarm_hub_crew_id) AS num
		FROM
			urbanfarm_hub_crew AS c
			LEFT JOIN
			farmer_farming_plan AS f
			ON c.urbanfarm_hub_crew_id = f.urbanfarm_hub_crew_id
		GROUP BY c.urbanfarm_hub_crew_id
		ORDER BY num
		LIMIT 1;
	</select>
	
	
	<select id="getFarmingPlanListById" resultMap="farmingPlanResultMap" parameterType="String">
		/* 사용자별 계획 리스트 */
		SELECT
			farmer_farming_plan_code,
			crops_name,
			farmer_farming_plan_status
		FROM
			farmer_farming_plan
		WHERE
			urbanfarmer_id=#{userId}
	</select>
	
	<insert id="addCrops" parameterType="Map">
		/* 농사 예정 작물 등록 */
		<selectKey keyColumn="crops_name,crops_growing_info_code" keyProperty="cropsName,cropsGrowingInfoCode" resultType="Map" order="BEFORE">
			SELECT
				crops_name,
				crops_growing_info_code
			FROM
				crops_growing_info
			WHERE
				crops_name_code = #{cropsNameCode}
		</selectKey>
		INSERT INTO farmer_farming_plan
			(farmer_farming_plan_code,
			 urbanfarmer_id, 
			 urbanfarm_hub_crew_id, 
			 crops_name_code, 
			 crops_name, 
			 crops_growing_info_code,
			 <if test="urbanKitCode !=null and urbanKitCode != ''">
				 urban_kit_code, 			 
			 </if> 
			 <if test="farmerFarmingPlanNickname !=null and farmerFarmingPlanNickname != ''">
				 farmer_farming_plan_nickname, 			 
			 </if> 
			 farmer_farming_plan_reg_date,
			 farmer_farming_plan_status)
		VALUES 
			(#{farmerFarmingPlanCode},
			 #{urbanfarmerId}, 
			 #{urbanfarmHubCrewId}, 
			 #{cropsNameCode}, 
			 #{cropsName}, 
			 #{cropsGrowingInfoCode},
			 <if test="urbanKitCode !=null and urbanKitCode != ''">
				 #{urbanKitCode}, 			 
			 </if>
			 <if test="farmerFarmingPlanNickname !=null and farmerFarmingPlanNickname != ''">
				 #{farmerFarmingPlanNickname}, 			 
			 </if>  
			 NOW(), 
			 '시작전')
	</insert>
</mapper>